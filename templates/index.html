<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Notes Summarizer + Quiz + Feedback</title>
    <style>
        #conversation {
            width: 600px;
            min-height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 1em;
            font-family: Arial, sans-serif;
            overflow-y: auto;
            max-height: 400px;
        }
        .question { color: #0044cc; margin-top: 10px; font-weight: bold; }
        .answer { color: #006600; margin-bottom: 15px; white-space: pre-wrap;}
        #quizResult, #feedbackResult {
            white-space: pre-wrap;
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 8px;
            max-width: 600px;
            margin-top: 20px;
        }
        textarea { font-family: monospace; }
    </style>
</head>
<body>
    <h1>Upload Notes (txt, pdf, docx)</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="files" multiple required />
        <button type="submit">Upload and Summarize</button>
    </form>

    <h2>File Summaries</h2>
    <div id="fileSummaries">Upload files to see summaries here.</div>

    <h2>Conversation</h2>
    <div id="conversation">Ask a question after upload.</div>

    <input type="text" id="followUpInput" placeholder="Enter follow-up question" style="width:400px" disabled/>
    <button id="askBtn" disabled>Ask</button>

    <h2>Generate MCQ Quiz from Notes</h2>
    <input type="number" id="numQuestions" placeholder="Number of questions" min="1" style="width:60px;" />
    <button onclick="generateQuiz()">Generate Quiz</button>
    <div id="quizResult">Quiz will appear here.</div>

    <h2>Submit Quiz Results for Feedback</h2>
    <textarea id="quizJson" rows="6" style="width:600px;" placeholder='Paste quiz results JSON here e.g. [{"question":"...", "chosen_answer":"...", "correct_answer":"..."}]'></textarea>
    <br>
    <button onclick="getQuizFeedback()">Get Feedback</button>
    <pre id="feedbackResult">Quiz feedback will appear here.</pre>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const fileSummariesDiv = document.getElementById('fileSummaries');
        const conversationDiv = document.getElementById('conversation');
        const followUpInput = document.getElementById('followUpInput');
        const askBtn = document.getElementById('askBtn');

        uploadForm.onsubmit = async (e) => {
            e.preventDefault();
            fileSummariesDiv.innerHTML = "Uploading...";
            conversationDiv.innerHTML = "";
            const formData = new FormData(uploadForm);
            const res = await fetch('/upload', {method:'POST', body: formData});
            const data = await res.json();

            alert(data.message);

            fileSummariesDiv.innerHTML = "";
            for(let file in data.summaries){
                fileSummariesDiv.innerHTML += `<strong>${file}</strong>:<br>${data.summaries[file]}<br><br>`;
            }

            followUpInput.disabled = false;
            askBtn.disabled = false;
            followUpInput.focus();
            conversationDiv.innerHTML = "You can now ask follow-up questions based on uploaded notes.";
            document.getElementById("quizResult").textContent = 'Quiz will appear here.';
            document.getElementById("feedbackResult").textContent = 'Quiz feedback will appear here.';
        };

        askBtn.addEventListener('click', async () => {
            const question = followUpInput.value.trim();
            if(!question) return;
            addQuestion(question);
            followUpInput.value = "";
            conversationDiv.innerHTML += `<div class="answer">Typing...</div>`;
            conversationDiv.scrollTop = conversationDiv.scrollHeight;

            const res = await fetch('/followup', {
                method:'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({query: question})
            });
            const data = await res.json();

            conversationDiv.querySelector('.answer:last-child').remove();
            addAnswer(data.response);
            conversationDiv.scrollTop = conversationDiv.scrollHeight;
        });

        function addQuestion(text) {
            const div = document.createElement('div');
            div.className = 'question';
            div.textContent = "Q: " + text;
            conversationDiv.appendChild(div);
        }

        function addAnswer(text) {
            const div = document.createElement('div');
            div.className = 'answer';
            div.textContent = "A: " + text;
            conversationDiv.appendChild(div);
        }

        async function generateQuiz() {
            const numQuestions = document.getElementById('numQuestions').value;
            if (!numQuestions || numQuestions <= 0) {
                alert("Enter a valid question count.");
                return;
            }
            const quizResultDiv = document.getElementById('quizResult');
            quizResultDiv.textContent = 'Generating quiz...';
            const res = await fetch('/generate_quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ num_questions: numQuestions })
            });
            const data = await res.json();

            if(data.quiz && data.quiz.length){
                let html = "";
                data.quiz.forEach((qobj, idx) => {
                    html += `<b>${idx+1}. ${qobj.question}</b><br>`;
                    qobj.options.forEach((opt, j) => {
                        const optLabels = ['A','B','C','D'];
                        html += `${optLabels[j]}. ${opt}<br>`;
                    });
                    html += "<br>";
                });
                quizResultDiv.innerHTML = html;
            } else {
                quizResultDiv.textContent = data.message;
            }
        }

        async function getQuizFeedback() {
            try {
                const quizResultsRaw = document.getElementById('quizJson').value;
                let quizResults = JSON.parse(quizResultsRaw);
                if (!Array.isArray(quizResults) || quizResults.length === 0) {
                    document.getElementById('feedbackResult').textContent = "Paste a valid quiz JSON array.";
                    return;
                }
                document.getElementById('feedbackResult').textContent = 'Requesting feedback...';
                const res = await fetch('/quiz_feedback', {
                    method: "POST",
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ quiz_results: quizResults })
                });
                const data = await res.json();
                document.getElementById('feedbackResult').textContent = data.feedback;
            } catch (e) {
                document.getElementById('feedbackResult').textContent = "Error parsing quiz results JSON!";
            }
        }
    </script>
</body>
</html>
